### Test Infrastructure Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    COMPLETE TEST INFRASTRUCTURE                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐     ┌───────────────────────────┐
│                     LOCAL MACHINE (Linux)                │     │     AWS EC2 (Ubuntu)      │
│                                                               │     │                           │
│  ┌──────────────────┐                                         │     │  ┌─────────────────────┐  │
│  │   Email Client   │                                         │     │  │    MAIL SERVER      │  │
│  │   (Thunderbird)  │                                         │     │  │  mail.nsipmail.de   │  │
│  │                  │                                         │     │  │    13.62.95.49      │  │
│  │  Proxy: No proxy │                                         │     │  │                     │  │
│  └────────┬─────────┘                                         │     │  │  Postfix (SMTP)     │  │
│           │                                                   │     │  │  Dovecot (IMAP/POP3)│  │
│           │ Outgoing traffic to mail server                   │     │  │                     │  │
│           ▼                                                   │     │  │  Let's Encrypt Cert │  │
│  ┌────────────────────────────────────────────────────────┐   │     │  └──────────┬──────────┘  │
│  │                 KERNEL (iptables)                      │   │     │             │             │
│  │                 NAT OUTPUT Chain                       │   │     │             │             │
│  │                                                        │   │     │             │             │
│  │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │   │     │             │             │
│  │   │Port 143 │ │Port 993 │ │Port 587 │ │Port 465 │      │   │     │             │             │
│  │   │ (IMAP)  │ │ (IMAPS) │ │ (SMTP)  │ │ (SMTPS) │      │   │     │             │             │
│  │   └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘      │   │     │             │             │
│  │        │           │           │           │           │   │     │             │             │
│  │   ┌─────────┐ ┌─────────┐                              │   │     │             │             │
│  │   │Port 110 │ │Port 995 │    ALL REDIRECT TO :8080     │   │     │             │             │
│  │   │ (POP3)  │ │ (POP3S) │                              │   │     │             │             │
│  │   └────┬────┘ └────┬────┘                              │   │     │             │             │
│  │        │           │           │           │           │   │     │             │             │
│  │        └───────────┴───────────┴───────────┘           │   │     │             │             │
│  │                        │                               │   │     │             │             │
│  └────────────────────────┼───────────────────────────────┘   │     │             │             │
│                           ▼                                   │     │             │             │
│  ┌────────────────────────────────────────────────────────┐   │     │             │             │
│  │                    mitmproxy                           │   │     │             │             │
│  │              --mode transparent                        │   │     │             │             │
│  │              --listen-port 8080                        │   │     │             │             │
│  │                                                        │   │     │             │             │
│  │   Loaded Script: imap/t1.py, smtp/t2.py, pop3/t3.py... │───┼─────┼─────────────┤             │
│  │                                                        │   │     │             │             │
│  │   Intercepts & manipulates traffic before forwarding   │   │     │             │             │
│  └────────────────────────────────────────────────────────┘   │     │             ▼             │
│                                                               │     │  ┌─────────────────────┐  │
└───────────────────────────────────────────────────────────────┘     │  │   Accepts traffic   │  │
                                                                      │  │   on all ports      │  │
                                                                      │  └─────────────────────┘  │
                                                                      └───────────────────────────┘
```
